---
title: "Control_data_rozen_vs_jill"
author: "Xinyi"
date: "2023-02-27"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### prepare packages 
```{r, libraries, echo=TRUE, message=FALSE}
# CRAN packages
library(ICAMS)
#BiocManager::install("ICAMS")
library(philentropy)
library(factoextra)
library(gplots)
library(nloptr)

# Other
devtools::load_all(".")
library(BSgenome.Hsapiens.1000genomes.hs37d5)
```
# Functions for this File 
```{r}
pcat <- function(catalog) {
  par(pin = c(3*ncol(catalog), 1))
  par(mfrow = c(ncol(catalog), 1))
  par(mar = c(2, 4, 4, 2))
  par(cex = 0.8)
  par(cex.main = 1.4) 
  xlabels <- FALSE
  for (i in 1:ncol(catalog)) {
    if (FALSE && i == ncol(catalog)) { # FALSE an experiment
      xlabels <- TRUE
      par(mar = c(4.5, 4, 3, 2))
    }
    
    ICAMS::PlotCatalog(catalog[ , i, drop = FALSE],
                       upper = (i == 1),
                       xlabels = xlabels)
  }
}
```

```{r}
convert_base <- function(x){
  if (x == "A")
    ret <- "T"
  else if (x == "C")
    ret <- "G"
  else if (x == "G")
    ret <- "C"
  else if (x == "T")
    ret <- "A"
  else{
    message("Incorrent input")
    ret <- 0
  }
    
  return(ret)
}
```

```{r}
Jill_to_SBS96 <- function(input_table){
  subs <- input_table[,c("pre_context","Ref","rear_context","Alt")]
  for (i in 1:nrow(input_table)){
    if (subs[i,2] == "A" | subs[i,2] =="G"){
      tmp1 <- convert_base(subs[i,1])
      tmp2 <- convert_base(subs[i,2])
      tmp3 <- convert_base(subs[i,3])
      tmp4 <- convert_base(subs[i,4])
      subs[i,1] <- tmp3
      subs[i,2] <- tmp2
      subs[i,3] <- tmp1
      subs[i,4] <- tmp4
    }
  }
  subs.pasted <- apply(subs, MARGIN = 1, function(x){paste0(x[1], x[2], x[3], x[4])})
  SBS96.template <- c("ACAA", "ACCA", "ACGA", "ACTA", "CCAA", "CCCA", "CCGA", "CCTA", 
                      "GCAA", "GCCA", "GCGA", "GCTA", "TCAA", "TCCA", "TCGA", "TCTA", 
                      "ACAG", "ACCG", "ACGG", "ACTG", "CCAG", "CCCG", "CCGG", "CCTG", 
                      "GCAG", "GCCG", "GCGG", "GCTG", "TCAG", "TCCG", "TCGG", "TCTG",
                      "ACAT", "ACCT", "ACGT", "ACTT", "CCAT", "CCCT", "CCGT", "CCTT", 
                      "GCAT", "GCCT", "GCGT", "GCTT", "TCAT", "TCCT", "TCGT", "TCTT", 
                      "ATAA", "ATCA", "ATGA", "ATTA", "CTAA", "CTCA", "CTGA", "CTTA", 
                      "GTAA", "GTCA", "GTGA", "GTTA", "TTAA", "TTCA", "TTGA", "TTTA", 
                      "ATAC", "ATCC", "ATGC", "ATTC", "CTAC", "CTCC", "CTGC", "CTTC", 
                      "GTAC", "GTCC", "GTGC", "GTTC", "TTAC", "TTCC", "TTGC", "TTTC", 
                      "ATAG", "ATCG", "ATGG", "ATTG", "CTAG", "CTCG", "CTGG", "CTTG", 
                      "GTAG", "GTCG", "GTGG", "GTTG", "TTAG", "TTCG", "TTGG", "TTTG") 
  subs.spectra <- rep(0,96)
  names(subs.spectra) <- SBS96.template
  
  # count occurrence 
  for (i in subs.pasted){
    subs.spectra[i] <- subs.spectra[i] + 1
  }
  
  subs.cat <- as.catalog(as.matrix(subs.spectra), ref.genome = "GRCh37", region = "genome", catalog.type = "counts" , infer.rownames = TRUE)
  
  return(subs.cat)
}
```

### Prepare Controls
##### Load the controls from vcfs (our data)
```{r}
dnames <- c(
  "HepG2_Control",
  "HepG2-Hamster-S9",
  "HepG2-RatS9",
  "HepG2-RatS9-DMSO",
  "MCF10A_Control",
  "MCF10A-Hamster-S9",
  "MCF10A-RatS9",
  "MCF10A-RatS9-DMSO"
)

hack_ref_genome <- function(dname) {
  if (grepl("_Control", dname)) {
    return("GRCh37")
  } else {
    return("hg38")
  }
}

get_spectra <- function(dd) {
  
  vcfs <- list.files(path = file.path("../data/controls_data_vcf/", dd), 
                     full.names = TRUE)
  return(
    ICAMS::VCFsToCatalogs(
      vcfs,
      ref.genome = hack_ref_genome(dd),
      variant.caller = "strelka",
      region = "genome"))
}

rozen_ctrl_spectra <- lapply(dnames, get_spectra)
names(rozen_ctrl_spectra) = dnames

rozen_ctrl_s96 <- lapply(dnames, function(dd) {spectra[[dd]]$catSBS96} )
```

##### Load the controls (Jill's dataï¼‰
Read Input from Jill Kucab's data
```{r}
subs.all <- read.table("Jill_Kucab_paper/Jill_denovo_subclone_subs_final.txt",header = TRUE, sep ="\t")
```

```{r}
by.sample <- split(subs.all, subs.all$Sample.Name)
all.spectra <- lapply(by.sample, Jill_to_SBS96)
alls <- do.call(cbind, all.spectra)
rownames(MSM_table) <- MSM_table$Sample.Name
colnames(alls) <- paste(colnames(alls), MSM_table[colnames(alls), "Treatment"])
ICAMS::PlotCatalogToPdf(alls, "jill.all.pdf")
ICAMS::PlotCatalogToPdf(alls[ , grepl("Control", colnames(alls), fixed = TRUE)], "jill.control.pdf")
```


### Generate BG info 
```{r}
bg.media <- MakeBackgroundInfo(all.controls)
```

```{r, fig.height=1.5, fig.width=10}
colnames(bg.media$background.sig) <- "Jill's controls"
pcat(bg.media$background.sig)
```

```{r,fig.height=3, fig.width=10}
# cannot mix catalog with different refernce genome 
hepg2.else.bg <- MakeBackgroundInfo(cbind(hepg2.HS9.spec, hepg2.RS9.spec, hepg2.RS9_DMSO.spec))
mcf10a.else.bg <- MakeBackgroundInfo(cbind(mcf10a.HS9.spec, mcf10a.RS9.spec, mcf10a.RS9_DMSO.spec))
colnames(hepg2.else.bg$background.sig) <- "hepg2.else.bg"
colnames(mcf10a.else.bg$background.sig) <- "mcf10a.else.bg"
pcat(cbind(hepg2.else.bg$background.sig, mcf10a.else.bg$background.sig))
```
#### HepG2
```{r,fig.height=6, fig.width=10}
hepg2.bg <- MakeBackgroundInfo(hepg2.ctrl.spec)$background.sig
hepg2.HS9.bg <- MakeBackgroundInfo(hepg2.HS9.spec)$background.sig
hepg2.RS9.bg <- MakeBackgroundInfo(hepg2.RS9.spec)$background.sig
hepg2.RS9_DMSO.bg <- MakeBackgroundInfo(hepg2.RS9_DMSO.spec)$background.sig

pcat(cbind(hepg2.bg,
           hepg2.HS9.bg,
           hepg2.RS9.bg,
           hepg2.RS9_DMSO.bg))
```
#### MCF10a
```{r,fig.height=6, fig.width=10}
# MCF10a
mcf10a.bg <- MakeBackgroundInfo(mcf10a.ctrl.spec)$background.sig
mcf10a.HS9.bg <- MakeBackgroundInfo(mcf10a.HS9.spec)$background.sig
mcf10a.RS9.bg <- MakeBackgroundInfo(mcf10a.RS9.spec)$background.sig
mcf10a.RS9_DMSO.bg <- MakeBackgroundInfo(mcf10a.RS9_DMSO.spec)$background.sig

pcat(cbind(mcf10a.bg,
           mcf10a.HS9.bg,
           mcf10a.RS9.bg,
           mcf10a.RS9_DMSO.bg))
```

```{r}

```



