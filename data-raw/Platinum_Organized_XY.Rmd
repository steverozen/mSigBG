---
title: "Platinum_Exploration_XY"
author: "Xinyi"
date: '2022-12-31'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Preparation

### prepare packages 
```{r, libraries, echo=TRUE, message=FALSE}
# CRAN packages
library(ICAMS)
library(philentropy)
library(factoextra)
library(gplots)
library(nloptr)

# Bioconductor
library(BSgenome.Hsapiens.1000genomes.hs37d5)
# If not available,
# install.packages("BiocManager")
# BiocManager::install("BSgenome.Hsapiens.1000genomes.hs37d5")

# Other
library(mSigBG)
# if not available
# install.packages("remotes")
# remotes::install_github("steverozen/mSigBG", ref = "1.0-branch")
library(PCAWG7)
# if not available
# remotes::install_github("steverozen/PCAWG7")
```

## Functions for later

### Catalog Plotting Functions
```{r}
#{r, define_pcat, echo=params$verbose}
pcat <- function(catalog) {
  par(pin = c(3*ncol(catalog), 1))
  par(mfrow = c(ncol(catalog), 1))
  par(mar = c(2, 4, 4, 2))
  par(cex = 0.8)
  par(cex.main = 1.4) 
  xlabels <- FALSE
  for (i in 1:ncol(catalog)) {
    if (FALSE && i == ncol(catalog)) { # FALSE an experiment
      xlabels <- TRUE
      par(mar = c(4.5, 4, 3, 2))
    }
    
    ICAMS::PlotCatalog(catalog[ , i, drop = FALSE],
                       upper = (i == 1),
                       xlabels = xlabels)
  }
}
```

### Background separation function: Separate the background and target signatures

```{r, separate.hepg2}
one.separation <- function(sig.name, spectra, bg.sig.info, my.seed = 101010) {
  
  set.seed(my.seed, kind = "L'Ecuyer-CMRG")
  
  if (is.null(attr(spectra, "abundance"))) {
    stop("NULL abundance for ", sig.name)
  }
  
  ret <- SeparateSignatureAndSpectra(
    spectra          = spectra,
    bg.sig.info      = bg.sig.info,
    m.opts           = NULL,
    start.b.fraction = 0.5,
    sig.name         = sig.name
  )

  return(ret)
}
```


## Read Input data 

The variables here contain ICAMS catalogs containing
spectra; each variable is for one
cell line and one exposure.

```{r, get_spectra}

hepg2.car  <- ICAMS::ReadCatalog("spectra/HepG2_Car.csv", 
                                 ref.genome = BSgenome.Hsapiens.1000genomes.hs37d5,
                                 region = "genome",
                                 catalog.type = "counts")

hepg2.oxa  <- ICAMS::ReadCatalog("spectra/HepG2_Oxa.csv", 
                                 ref.genome = BSgenome.Hsapiens.1000genomes.hs37d5,
                                 region = "genome",
                                 catalog.type = "counts")

mcf10a.car <- ICAMS::ReadCatalog("spectra/MCF10A_Car.csv", 
                                 ref.genome = BSgenome.Hsapiens.1000genomes.hs37d5,
                                 region = "genome",
                                 catalog.type = "counts")

hepg2.cis <- mSigBG::example.spectra$HepG2.cisplatin

mcf10a.cis <- mSigBG::example.spectra$MCF10A.cisplatin

```

```{r, signture.lists}
hepg2.exposures <- list(HepG2.cis.sig = hepg2.cis, HepG2.car.sig = hepg2.car, HepG2.oxa.sig = hepg2.oxa)


mcf10a.exposures <- list(mcf10a.cis, mcf10a.car)
names(mcf10a.exposures) <- c("MCF10A.cis.sig", "MCF10.car.sig")
```


### Separate intrinsic from target for all cell line X exposure pairs

```{r}

hepg2.cis.sep <- one.separation("hepg2.cis", hepg2.cis, background.info[["HepG2"]])

# Are the inferred target signatures by method 1 similar across the 4 hepg2 spectra?

mcf10a.cis.sep <- one.separation("mcf10a.cis", mcf10a.cis, background.info[["HepG2"]])

# Are the inferred target signatures by method 1 similar across the 4 mcfa1 spectra?

# If the 2 quesions above are true, then look at overal cossim between 
# the inferred target signatures of hepg2 and mcf10a as a whole and by
# subcolor_sim.

if (!file.exists("all.separated.Rdata")) {
  hepg2.separated <- lapply(X           = names(hepg2.exposures),
                            FUN         = one.separation,
                            sig.list    = hepg2.exposures,
                            bg.sig.info = background.info[["HepG2"]])
  names(hepg2.separated) <- names(hepg2.exposures)
}
if (!file.exists("all.separated.Rdata")) {
  mcf10a.separated <- lapply(X           = names(mcf10a.exposures),
                             FUN         = one.separation,
                             sig.list    = mcf10a.exposures,
                             bg.sig.info = background.info[["MCF10A"]])
  names(mcf10a.separated) <- names(mcf10a.exposures)
  
  all.separated <- c(hepg2.separated, mcf10a.separated)
  save(all.separated, file = "all.separated.Rdata")
} else {
  load("all.separated.Rdata")
}

# output of BG Sep for both cell lines: all.separated
```

# Exploration
## Two Ways of getting Inferred spectra from all.separated 

### Method 1: obs.spectra - (bg.exposure * the background signature) 
```{r}
# Spectra of each sample (matrix)
all.spectra <- do.call(cbind, c(hepg2.exposures, mcf10a.exposures))

# Spectra of each sample (list)
all.obs.spectra <- c(hepg2.exposures, mcf10a.exposures)

# No. of mutation due to bg in each sample
all.bg.exposure <- lapply(all.separated, 
       function(x) { 
         bg.exposures <- x$exposures.to.bg.sig
         names <- colnames(x$inferred.bg.spectra)
         names(bg.exposures) <- sub("-inf.bg.spect", "", names, fixed = TRUE)
         return(bg.exposures)
       })

#unlist(c(all.bg.exposure))

all.bg.spectra <-lapply(all.separated, 
       function(x) { 
         bg.sig <- x$inferred.bg.spectra
         names <- colnames(x$inferred.bg.spectra)
         colnames(bg.sig) <- sub("-inf.bg.spect", "", names, fixed = TRUE)
         return(bg.sig)
       })


all.bg.sig <- lapply(all.bg.spectra,function(x){
                  for (i in 1:ncol(x)){
                      temp <- (x[,i]/colSums(x)[i])
                      x[,i] <- temp
                  } 
                  return(x)
              })

rm("bg.spectra")
for (x in names(all.bg.exposure)){
  for (i in names(all.bg.exposure[[x]])){
    # this multiplication is problematic: all.bg.sig$x[,i] is a count signature 
    this.bg.spectra <- all.bg.exposure[[x]][i] * all.bg.sig[[x]][,i, drop=FALSE]
    if (!exists("bg.spectra")){
       bg.spectra <- this.bg.spectra
    }
    else{
      bg.spectra <- cbind(bg.spectra, this.bg.spectra)
    }
  }
}  

all.inferred.target.spectra.method1 <- all.spectra - bg.spectra

# transform the inferred spectra into catalog 
# plot the catalog 
# later on calculate cosine similarity with the other method


```


### Method 2: (obs.counts - bg.exposure) * sig.to.return 
```{r}
# Spectra of each sample (matrix)
all.spectra <- do.call(cbind, c(hepg2.exposures, mcf10a.exposures))
# No.of total mutation observed in each sample
all.obs.counts <- as.matrix(colSums(all.spectra))

# Spectra of each sample (list)
all.obs.spectra <- c(hepg2.exposures, mcf10a.exposures)
# No.of total mutation observed in each sample
all.obs.counts <- lapply(all.obs.spectra, colSums)


# No. of mutation due to bg in each sample
all.bg.exposure <- lapply(all.separated, 
       function(x) { 
         bg.exposures <- x$exposures.to.bg.sig
         names <- colnames(x$inferred.bg.spectra)
         names(bg.exposures) <- sub("-inf.bg.spect", "", names, fixed = TRUE)
         return(bg.exposures)
       })



# front part of the multiplication
# all.obs.counts - unlist(all.bg.exposure)

all.target.sig <-lapply(all.separated, 
       function(x) { 
         target.sig <- x$inferred.target.sig.as.catalog
         return(target.sig)
       })
names(all.target.sig)<-names(all.separated)

rm("inferred.target.spectra.method2")
for (i in names(all.separated)){
  for (j in 1:length(all.bg.exposure[[i]])){
    inferred.target.count <- all.obs.counts[[i]][j] - all.bg.exposure[[i]][j]
    temp.inferred.spectra <- inferred.target.count %*% all.target.sig[[i]][,1]
    #Error in all.target.sig[[i]][, j] : subscript out of bounds
    temp.inferred.spectra <- t(temp.inferred.spectra)
    colnames(temp.inferred.spectra) <- names(inferred.target.count)
    
    if(!exists("inferred.target.spectra.method2")){
      inferred.target.spectra.method2 <- temp.inferred.spectra
    }else{
      inferred.target.spectra.method2 <- cbind(inferred.target.spectra.method2,temp.inferred.spectra)
    }
  }
}

all.inferred.target.spectra.method2 <- inferred.target.spectra.method2
```

## Question 1: Are the Cis-platinum and Carbo-platinum target signatures the same for HepG2 and MCF10A?


```{r}
colnames(all.inferred.target.spectra.method1)

all.inferred.target.spectra.method1.cl <- all.inferred.target.spectra.method1
tmp.names <- colnames(all.inferred.target.spectra.method1.cl)
colnames(all.inferred.target.spectra.method1.cl) <- sub("HepG2.cis.sig.|HepG2.car.sig.|MCF10A.cis.sig.|MCF10.car.sig.", "", tmp.names)

HepG2_Cis <- all.inferred.target.spectra.method1.cl[,1:4, drop = FALSE] # 4
HepG2_Car <- all.inferred.target.spectra.method1.cl[,5:6, drop = FALSE] # 2
MCF10A_Cis <- all.inferred.target.spectra.method1.cl[,10:15, drop = FALSE] # 6
MCF10A_Car <- all.inferred.target.spectra.method1.cl[,16:19, drop = FALSE] # 4

```

```{r,fig.height=4, fig.width=7}
pcat(cbind(all.inferred.target.spectra.method1.cl[,1, drop = FALSE],all.inferred.target.spectra.method1.cl[,10, drop = FALSE]))
```

```{r}
subcolor_sim(cbind(HepG2_Cis,HepG2_Cis,HepG2_Cis), cbind(MCF10A_Cis,MCF10A_Cis))
```

```{r,fig.height=4, fig.width=7}
pcat(cbind(HepG2_Car[,1,drop=FALSE],MCF10A_Car[,1, drop = FALSE]))
```

```{r}
subcolor_sim(cbind(HepG2_Car,HepG2_Car), MCF10A_Cis)
```

## Question 2: What are the background signatures of HepG2 and MCF10A? Does Cis-platinum or Carbo-platinum enhanced some of the intrinsic signature 
## Question 2': What is the cosine similarity between the background and the target signature for both Cis and Car in both cellines?

#### Background signatures, for refrence
```{r, plot bg sig, fig.height=4, fig.width=7} 

pcat(cbind(mSigBG::background.info[["HepG2"]]$background.sig, mSigBG::background.info[["MCF10A"]]$background.sig))

```

## Qustion2 for Cis-platinum: 
### Question 2.1 Are the target sig similar enough in the two cell lines?
```{r,fig.height=4, fig.width=7}
# Plot the target signature of CIS-PLATINUM in both cell line 
pcat(cbind(all.target.sig$HepG2.cis.sig,all.target.sig$MCF10A.cis.sig))

```
```{r}
philentropy::cosine_dist(all.target.sig$HepG2.cis.sig,all.target.sig$MCF10A.cis.sig)
```

```{r}
subcolor_sim(all.target.sig$HepG2.cis.sig,all.target.sig$MCF10A.cis.sig)
```


### Question2.2: cosine similarity between subcolor of background and target (see if part of target is from intrinsic mutations)

```{r,fig.height=4, fig.width=7}
# Plot the target signature of CIS-PLATINUM in both cell line 
pcat(cbind(mSigBG::background.info[["HepG2"]]$background.sig,all.target.sig$HepG2.cis.sig))

```

```{r}
subcolor_sim(all.target.sig$HepG2.cis.sig,mSigBG::background.info[["HepG2"]]$background.sig)
```
```{r, fig.height=4,fig.width=7}
pcat(cbind(mSigBG::background.info[["MCF10A"]]$background.sig,all.target.sig$MCF10A.cis.sig))
```

```{r}
subcolor_sim(all.target.sig$MCF10A.cis.sig,mSigBG::background.info[["MCF10A"]]$background.sig)
```

## End of Qustion2 for Cis-platinum


## Question2 for carbo-platinum
### Question 2.1 Are the target sig similar enough in the two cell lines?
```{r,fig.height=4, fig.width=7}
# Plot the target signature of CARBO_PLATINUM in both cell line 
pcat(cbind(all.target.sig$HepG2.car.sig,all.target.sig$MCF10.car.sig))
```

```{r}
philentropy::cosine_dist(all.target.sig$HepG2.car.sig,all.target.sig$MCF10.car.sig)
```

```{r}
subcolor_sim(all.target.sig$HepG2.car.sig,all.target.sig$MCF10.car.sig)
```


### Question2.2: cosine similarity between subcolor of background and target (see if part of target is from intrinsic mutations)

```{r, fig.height =6, fig.width=7}
#all.target.sig$MCF10.car.sig
pcat(cbind(mSigBG::background.info[["HepG2"]]$background.sig,all.target.sig$HepG2.car.sig))
```
```{r}
subcolor_sim(mSigBG::background.info[["HepG2"]]$background.sig,all.target.sig$HepG2.car.sig)
```

```{r, fig.height =6, fig.width=7}
pcat(cbind(mSigBG::background.info[["MCF10A"]]$background.sig,all.target.sig$MCF10.car.sig))
```

```{r}
subcolor_sim(mSigBG::background.info[["MCF10A"]]$background.sig,all.target.sig$MCF10.car.sig)
```

## End of Qustion2 for Carbo-platinum


